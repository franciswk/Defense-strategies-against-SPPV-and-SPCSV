---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
#' MA Plots: Treatment vs Mock (ME/TJ, intervals 1 & 3)
#'
#' Generates DESeq2 MA plots comparing Treatment vs Mock for ME and TJ cultivars
#' at intervals 1 and 3 (replicates a/b/c), with LFC shrinkage (apeglm).
#'
#' Workflow:
#' - Load countdata_Trt_vs_Mock_0507.csv
#' - Build count matrices per group: ME_1, ME_3, TJ_1, TJ_3
#' - Create sample metadata (condition, replicate)
#' - Run DESeq2 (prefilter rowSums >= 10), contrast Treatment vs Mock
#' - Apply LFC shrinkage and save MA plots

#' Input: countdata_Trt_vs_Mock_0507.csv
#' Outputs: me_1_MA_plot.png, me_3_MA_plot.png, tj_1_MA_plot.png, tj_3_MA_plot.png (300 dpi, 8x6 in)
#' Data available on request
#' Please cite this publication when using this script: https://doi.org/10.1002/csc2.21392

```{r}
# Load necessary library
library(DESeq2)
library(dplyr)
library(apeglm)
```

```{r}
# Read the cts_all data from CSV file
eb_trtvmock <- read.csv("countdata_Trt_vs_Mock_0507.csv")

colnames(eb_trtvmock)
```

```{r}
# ME_1 DGE 

#Create counts df for the specific Trt and Mock
cts <- data.frame(" "= c(eb_trtvmock$Name),
                      Trt_ME_1_a = c(eb_trtvmock$Trt_ME_1_a_counts ),
                      Trt_ME_1_b = c(eb_trtvmock$Trt_ME_1_b_counts),
                      Trt_ME_1_c = c(eb_trtvmock$Trt_ME_1_c_counts),
                      Mock_ME_1_a = c(eb_trtvmock$Mock_ME_1_a_counts),
                      Mock_ME_1_b = c(eb_trtvmock$Mock_ME_1_b_counts),
                      Mock_ME_1_c = c(eb_trtvmock$Mock_ME_1_c_counts)
                      )
str(cts)
```

```{r}
# Set row names to the first column and remove the first column
rownames(cts) <- cts$X
countData <- cts[, -1]

# Convert to matrix (DESeq2 expects a matrix for countData)
countData <- as.matrix(countData)

# Verify the structure of countData
str(countData)
```

```{r}
# Column names of countData
column_names <- colnames(countData)

# Extract conditions (e.g., treatment vs. mock) and replicates from column names
condition <- ifelse(grepl("Trt", column_names), "Treatment", "Mock")
replicate <- sub(".*_(ME|TJ)_1_", "", column_names)

# Create colData data frame
colData <- data.frame(
  sample = column_names,
  condition = factor(condition),
  replicate = factor(replicate)
)

# Set row names to match column names of countData
rownames(colData) <- colData$sample

# Verify the structure of colData
str(colData)

```

```{r}
#check that column numbers are same as rows
colData
countData

dim(colData)
dim(countData)
```


```{r}
#Run DESEq2 DGE
library(DESeq2)

# Create DESeqDataSet object with appropriate design formula
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ condition)

# Optional pre-filtering for genes with total counts >= 10 (adjust threshold as needed)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

# Run DESeq2 analysis
dds <- DESeq(dds)
```


```{r}
# Extract results, specifically comparing 'Trt' to 'Mock'
res <- results(dds, contrast = c("condition", "Treatment", "Mock"))
# res
```

```{r}
# Filter significant DEGs
res <- res[!is.na(res$padj), ] # Remove rows with NA in padj

res <- res[abs(res$log2FoldChange) >= 1.5 & res$padj <= 0.05, ] # Filter results based on LFC >= 1.5 and FDR p-value <= 0.05

summary(res) #print result summary
```


```{r}
# Explore results (visualization and interpretation)
library(apeglm)

resLFC <- lfcShrink(dds, coef = 2, type = "apeglm") #Shrink Log2 Fold Changes: Reduce overdispersion and improves visualization
```

# Create and save MA-plot - Confirm the cts matches with file name
```{r}
# Open a PNG device
png("me_1_MA_plot.png", width = 8, height = 6, units = "in", res = 300)

# Create the MA-plot
plotMA(resLFC, ylim = c(-10, 10),
       xlab = "Mean normalized counts",
       ylab = "Log2 fold change",
       cex.lab = 1.5, # Increases axis label font size
       cex.axis = 1.2, # Increases axis tick mark font size
       cex.main = 1.5, # Increases title font size
       cex.sub = 1.2) # Increases subtitle font size)

# Close the PNG device
dev.off()
```

# Repeat for the other cultivars/intervals
```{r}
# ME_3 DGE 

#Create counts df for the specific Trt and Mock
cts <- data.frame(" "= c(eb_trtvmock$Name),
                      Trt_ME_3_a = c(eb_trtvmock$Trt_ME_3_a_counts),
                      Trt_ME_3_b = c(eb_trtvmock$Trt_ME_3_b_counts),
                      Trt_ME_3_c = c(eb_trtvmock$Trt_ME_3_c_counts),
                      Mock_ME_3_a = c(eb_trtvmock$Mock_ME_3_a_counts),
                      Mock_ME_3_b = c(eb_trtvmock$Mock_ME_3_b_counts),
                      Mock_ME_3_c = c(eb_trtvmock$Mock_ME_3_c_counts)
                      )
str(cts)

```


```{r}
# Set row names to the first column and remove the first column
rownames(cts) <- cts$X
countData <- cts[, -1]

# Convert to matrix (DESeq2 expects a matrix for countData)
countData <- as.matrix(countData)

# Verify the structure of countData
str(countData)
```

```{r}
# Column names of countData
column_names <- colnames(countData)

# Extract conditions (e.g., treatment vs. mock) and replicates from column names
condition <- ifelse(grepl("Trt", column_names), "Treatment", "Mock")
replicate <- sub(".*_(ME|TJ)_1_", "", column_names)

# Create colData data frame
colData <- data.frame(
  sample = column_names,
  condition = factor(condition),
  replicate = factor(replicate)
)

# Set row names to match column names of countData
rownames(colData) <- colData$sample

# Verify the structure of colData
str(colData)

```

```{r}
#check that column numbers are same as rows
colData
countData

dim(colData)
dim(countData)
```


```{r}
#Run DESEq2 DGE
library(DESeq2)

# Create DESeqDataSet object with appropriate design formula
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ condition)

# Optional pre-filtering for genes with total counts >= 10 (adjust threshold as needed)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

# Run DESeq2 analysis
dds <- DESeq(dds)
```


```{r}
# Extract results, specifically comparing 'Trt' to 'Mock'
res <- results(dds, contrast = c("condition", "Treatment", "Mock"))
# res
```

```{r}
# Filter significant DEGs
res <- res[!is.na(res$padj), ] # Remove rows with NA in padj

res <- res[abs(res$log2FoldChange) >= 1.5 & res$padj <= 0.05, ] # Filter results based on LFC >= 1.5 and FDR p-value <= 0.05

summary(res) #print result summary
```


```{r}
# Explore results (visualization and interpretation)
library(apeglm)

resLFC <- lfcShrink(dds, coef = 2, type = "apeglm") #Shrink Log2 Fold Changes: Reduce overdispersion and improves visualization
```

# Create and save MA-plot - Confirm the cts matches with file name
```{r}
# Open a PNG device
png("me_3_MA_plot.png", width = 8, height = 6, units = "in", res = 300)

# Create the MA-plot
plotMA(resLFC, ylim = c(-10, 10),
       xlab = "Mean normalized counts",
       ylab = "Log2 fold change",
       cex.lab = 1.5, # Increases axis label font size
       cex.axis = 1.2, # Increases axis tick mark font size
       cex.main = 1.5, # Increases title font size
       cex.sub = 1.2) # Increases subtitle font size)

# Close the PNG device
dev.off()
```


```{r}
# TJ_1 DGE 

#Create counts df for the specific Trt and Mock
cts <- data.frame(" "= c(eb_trtvmock$Name),
                      Trt_TJ_1_a = c(eb_trtvmock$Trt_TJ_1_a_counts),
                      Trt_TJ_1_b = c(eb_trtvmock$Trt_TJ_1_b_counts),
                      Trt_TJ_1_c = c(eb_trtvmock$Trt_TJ_1_c_counts),
                      Mock_TJ_1_a = c(eb_trtvmock$Mock_TJ_1_a_counts),
                      Mock_TJ_1_b = c(eb_trtvmock$Mock_TJ_1_b_counts),
                      Mock_TJ_1_c = c(eb_trtvmock$Mock_TJ_1_c_counts)
                      )
str(cts)
```


```{r}
# Set row names to the first column and remove the first column
rownames(cts) <- cts$X
countData <- cts[, -1]

# Convert to matrix (DESeq2 expects a matrix for countData)
countData <- as.matrix(countData)

# Verify the structure of countData
str(countData)
```

```{r}
# Column names of countData
column_names <- colnames(countData)

# Extract conditions (e.g., treatment vs. mock) and replicates from column names
condition <- ifelse(grepl("Trt", column_names), "Treatment", "Mock")
replicate <- sub(".*_(ME|TJ)_1_", "", column_names)

# Create colData data frame
colData <- data.frame(
  sample = column_names,
  condition = factor(condition),
  replicate = factor(replicate)
)

# Set row names to match column names of countData
rownames(colData) <- colData$sample

# Verify the structure of colData
str(colData)

```

```{r}
#check that column numbers are same as rows
colData
countData

dim(colData)
dim(countData)
```


```{r}
#Run DESEq2 DGE
library(DESeq2)

# Create DESeqDataSet object with appropriate design formula
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ condition)

# Optional pre-filtering for genes with total counts >= 10 (adjust threshold as needed)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

# Run DESeq2 analysis
dds <- DESeq(dds)
```


```{r}
# Extract results, specifically comparing 'Trt' to 'Mock'
res <- results(dds, contrast = c("condition", "Treatment", "Mock"))
# res
```

```{r}
# Filter significant DEGs
res <- res[!is.na(res$padj), ] # Remove rows with NA in padj

res <- res[abs(res$log2FoldChange) >= 1.5 & res$padj <= 0.05, ] # Filter results based on LFC >= 1.5 and FDR p-value <= 0.05

summary(res) #print result summary
```


```{r}
# Explore results (visualization and interpretation)
library(apeglm)

resLFC <- lfcShrink(dds, coef = 2, type = "apeglm") #Shrink Log2 Fold Changes: Reduce overdispersion and improves visualization
```

# Create and save MA-plot - Confirm the cts matches with file name
```{r}
# Open a PNG device
png("tj_1_MA_plot.png", width = 8, height = 6, units = "in", res = 300)

# Create the MA-plot
plotMA(resLFC, ylim = c(-10, 10),
       xlab = "Mean normalized counts",
       ylab = "Log2 fold change",
       cex.lab = 1.5, # Increases axis label font size
       cex.axis = 1.2, # Increases axis tick mark font size
       cex.main = 1.5, # Increases title font size
       cex.sub = 1.2) # Increases subtitle font size)

# Close the PNG device
dev.off()
```


```{r}
# TJ_3 DGE 

#Create counts df for the specific Trt and Mock
cts <- data.frame(" "= c(eb_trtvmock$Name),
                      Trt_TJ_3_a = c(eb_trtvmock$Trt_TJ_3_a_counts),
                      Trt_TJ_3_b = c(eb_trtvmock$Trt_TJ_3_b_counts),
                      Trt_TJ_3_c = c(eb_trtvmock$Trt_TJ_3_c_counts),
                      Mock_TJ_3_a = c(eb_trtvmock$Mock_TJ_3_a_counts),
                      Mock_TJ_3_b = c(eb_trtvmock$Mock_TJ_3_b_counts),
                      Mock_TJ_3_c = c(eb_trtvmock$Mock_TJ_3_c_counts)
                      )
str(cts)
```


```{r}
# Set row names to the first column and remove the first column
rownames(cts) <- cts$X
countData <- cts[, -1]

# Convert to matrix (DESeq2 expects a matrix for countData)
countData <- as.matrix(countData)

# Verify the structure of countData
str(countData)
```

```{r}
# Column names of countData
column_names <- colnames(countData)

# Extract conditions (e.g., treatment vs. mock) and replicates from column names
condition <- ifelse(grepl("Trt", column_names), "Treatment", "Mock")
replicate <- sub(".*_(ME|TJ)_1_", "", column_names)

# Create colData data frame
colData <- data.frame(
  sample = column_names,
  condition = factor(condition),
  replicate = factor(replicate)
)

# Set row names to match column names of countData
rownames(colData) <- colData$sample

# Verify the structure of colData
str(colData)

```

```{r}
#check that column numbers are same as rows
colData
countData

dim(colData)
dim(countData)
```


```{r}
#Run DESEq2 DGE
library(DESeq2)

# Create DESeqDataSet object with appropriate design formula
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ condition)

# Optional pre-filtering for genes with total counts >= 10 (adjust threshold as needed)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

# Run DESeq2 analysis
dds <- DESeq(dds)
```


```{r}
# Extract results, specifically comparing 'Trt' to 'Mock'
res <- results(dds, contrast = c("condition", "Treatment", "Mock"))
# res
```

```{r}
# Filter significant DEGs
res <- res[!is.na(res$padj), ] # Remove rows with NA in padj

res <- res[abs(res$log2FoldChange) >= 1.5 & res$padj <= 0.05, ] # Filter results based on LFC >= 1.5 and FDR p-value <= 0.05

summary(res) #print result summary
```


```{r}
# Explore results (visualization and interpretation)
library(apeglm)

resLFC <- lfcShrink(dds, coef = 2, type = "apeglm") #Shrink Log2 Fold Changes: Reduce overdispersion and improves visualization
```

# Create and save MA-plot - Confirm the cts matches with file name
```{r}
# Open a PNG device
png("tj_3_MA_plot.png", width = 8, height = 6, units = "in", res = 300)

# Create the MA-plot
plotMA(resLFC, ylim = c(-10, 10),
       xlab = "Mean normalized counts",
       ylab = "Log2 fold change",
       cex.lab = 1.5, # Increases axis label font size
       cex.axis = 1.2, # Increases axis tick mark font size
       cex.main = 1.5, # Increases title font size
       cex.sub = 1.2) # Increases subtitle font size)

# Close the PNG device
dev.off()
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
